#!/usr/bin/env node
var M=Object.create;var R=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var W=Object.getOwnPropertyNames,$=Object.getOwnPropertySymbols,K=Object.getPrototypeOf,k=Object.prototype.hasOwnProperty,B=Object.prototype.propertyIsEnumerable;var S=(e,t,n)=>t in e?R(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,d=(e,t)=>{for(var n in t||(t={}))k.call(t,n)&&S(e,n,t[n]);if($)for(var n of $(t))B.call(t,n)&&S(e,n,t[n]);return e};var A=(e,t)=>{var n={};for(var r in e)k.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(e!=null&&$)for(var r of $(e))t.indexOf(r)<0&&B.call(e,r)&&(n[r]=e[r]);return n};var X=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of W(t))!k.call(e,o)&&o!==n&&R(e,o,{get:()=>t[o],enumerable:!(r=Q(t,o))||r.enumerable});return e};var T=(e,t,n)=>(n=e!=null?M(K(e)):{},X(t||!e||!e.__esModule?R(n,"default",{value:e,enumerable:!0}):n,e));var Y="3.0.0-alpha.46",m={RELEASE_BUMP_VERSION:Y};var I=require("console"),F=require("fs"),g=require("fs/promises"),L=require("path"),E=[{alternates:["changelog-path","changelog"],description:"Path to changelog.",name:"changelogPath",type:"string"},{alias:"c",alternates:["config-path","config"],description:"Path to config file",name:"configPath",type:"string"},{description:"Release date.",name:"date",type:"string"},{alias:"d",alternates:["dry-run","dry"],description:"Dry run.",name:"dryRun",type:"boolean"},{alias:"e",alternates:["fail-on-error","fail"],description:"Fail on error.",name:"failOnError",type:"boolean"},{alternates:["files-path","files"],description:"Path to directory of files to bump.",name:"filesPath",type:"string"},{description:"Directories to ignore.",name:"ignore",type:"string[]"},{alias:"h",description:"Log CLI usage text.",name:"help",type:"boolean"},{alias:"p",description:"Prefix release version with a 'v'.",name:"prefix",type:"boolean"},{alias:"q",description:"Quiet, no logs.",name:"quiet",type:"boolean"},{description:"Release version.",name:"release",type:"string"},{alternates:["repo"],description:"Remote git repository URL.",name:"repository",type:"string"},{alias:"v",description:"Log Release Bump version.",name:"version",type:"boolean"}];function q(e,t){return e.filter(n=>!t.some(r=>n.includes(r)))}function _(e){let t=[];return e.forEach(n=>{Array.isArray(n)?t.push(..._(n)):t.push(n)}),t}function U(e){if(typeof e=="string"){if(/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()!@:%_+.~#?&/=]*)/.test(e))return e;if(/^[-a-zA-Z0-9()!@:%_+~#?&=]+\/[-a-zA-Z0-9()!@:%_+~#?&=]+$/.test(e))return`https://github.com/${e}`}else return typeof(e==null?void 0:e.url)>"u"?"":U(e.url.replace(/(^git\+|\.git$)/,""));return""}async function N(e,t){var y,b;let{date:n,isChangelog:r,prefix:o,release:a,repository:i}=t;if(!/^\d+\.\d+\.\d+$/.test(a))return e;let l=(b=(y=/\d+\.\d+\.\d+/.exec(a))==null?void 0:y[0])!=null?b:a;if(r===!1)return e.replace(/@([Ss]ince|[Vv]ersion)(:?\s+)unreleased/g,`@$1$2${l}`);let c=i.includes("bitbucket.org")?"bitbucket":"github",f=`${i}/${c==="bitbucket"?"commits":"releases"}/tag/${o?"v":""}${l}`,p=`## [${o?"v":""}${l}]`+(i!==""?`(${f})`:"")+(n?` - ${n}`:"");if(e.includes(p))return e;let h=`(${i}/${c==="bitbucket"?"branches/":""}compare/HEAD..${o?"v":""}${l})`,C=`## [Unreleased]${i?h:""}

### `+["Added","Changed","Deprecated","Removed","Fixed","Security"].join(`

### `);return e.replace(/## \[Unreleased\](\(.*\))?/,p).replace(/### (Added|Changed|Deprecated|Removed|Fixed|Security)\n\n/g,"").replace(/### (Added|Changed|Deprecated|Removed|Fixed|Security)\n$/g,"").replace(/\n\n$/g,`
`).replace(p,C+`

`+p)}async function ee(e){var o,a;let t=e!=null?e:"";switch((o=["js","mjs","cjs","json"].find(i=>t.indexOf(`.${i}`)===t.length-`.${i}`.length))!=null?o:""){case"js":case"mjs":case"cjs":{let i=await Promise.resolve().then(()=>T(require(t))).catch(()=>({}));if(typeof i=="function"){let s=await i();if(typeof s!="object"||Object.keys(s).length<1)break;return s}else if(typeof i.default=="function"){let s=await i.default();if(typeof s!="object"||Object.keys(s).length<1)break;return s}if(Object.keys(i).length>0)return(a=i.default)!=null?a:i;break}case"json":try{return JSON.parse(await(0,g.readFile)(t,"utf8"))}catch(i){}break;default:break}return{}}function V(e){return[`Usage
	$ release-bump <options>`,"Options"+e.reduce((t,n)=>{let r=n.alias?(n.name.length<6?"	":"")+`	-${n.alias}`:"		",o=n.alias?`	${n.description}`:(n.name.length<6?"	":"")+n.description;return t+`
	--${n.name}${r}${o}`},""),`Examples
	$ release-bump -pq --files=src`].join(`

`)}async function v(e){let{directoriesToIgnore:t,failOnError:n,filesPath:r,paths:o}=e;if(t.some(s=>r.includes(s)))return o!=null?o:[];let a=[];try{a=await(0,g.readdir)(r)}catch(s){if(n)throw process.exitCode=1,s;a=[]}let i=await Promise.all(a.map(async s=>(await(0,g.stat)(`${r}/${s}`)).isDirectory()===!0?await v({directoriesToIgnore:t,failOnError:n,filesPath:`${r}/${s}`,paths:o}):(0,L.join)(`${r}/${s}`)));return[...new Set(_([...o,...i]))]}function z(e){return e!=null&&e.RELEASE_BUMP_VERSION?"v"+e.RELEASE_BUMP_VERSION:"no version found"}function Z({quiet:e}){return e===!0?new I.Console({stdout:(0,F.createWriteStream)("/dev/null"),stderr:(0,F.createWriteStream)("/dev/null")}):console}function G(e,t){return e.reduce((n,r,o)=>{let a={};if(r.indexOf("--")===0){let[i,s]=r.substr(2).split("="),l=t.find(c=>{var f;return c.name===i||((f=c==null?void 0:c.alternates)!=null?f:[]).includes(i)});if(l)switch(l.type){case"boolean":a[l.name]=!0;break;case"string[]":a[l.name]=s==null?void 0:s.split(",");break;default:a[l.name]=s;break}}else if(r.indexOf("-")===0)[...r.substr(1)].forEach(i=>{let s=t.find(l=>l.alias===i);s&&(a[s.name]=!0)});else{let i=Object.keys(n),s=i[i.length-1],l=t.find(c=>c.name===s);l&&(n[s]===`$${o-1}`||typeof n[s]>"u")&&(a[s]=l.type==="string[]"?r.split(","):r)}return d(d({},n),a)},{})}async function H(e){var s,l;let t,n=m.NODE_ENV==="test"||!1;try{t=JSON.parse(await(0,g.readFile)("package.json","utf8"))}catch(c){t={repository:"",version:"0.0.0"}}let r=[".git",".github","coverage","dist","node_modules","tests/fixtures"],o={changelogPath:"CHANGELOG.md",configPath:"release-bump.config.js",date:(s=new Date().toISOString().split("T"))==null?void 0:s[0],dryRun:!1,failOnError:!1,filesPath:".",ignore:r,prefix:!1,quiet:n,release:t.version,repository:U(t.repository)},a=await ee((l=e==null?void 0:e.configPath)!=null?l:o.configPath);return d(d(d({},o),a),e)}var P=require("fs/promises");async function J(e){let{changelogPath:t,date:n,dryRun:r,failOnError:o,filesPath:a,ignore:i,prefix:s,quiet:l,release:c,repository:f}=await H(e),p=Z({quiet:l}),h=i,y=await v({directoriesToIgnore:h,failOnError:o,filesPath:a,paths:[t]}),b=q(y,h),x=[];return await Promise.all(b.map(async u=>{let w="";try{w=await(0,P.readFile)(u,"utf8")}catch(O){if(o)throw process.exitCode=1,O;p.warn(`could not read ${u}`)}let j=await N(w,{date:n,isChangelog:t===u,prefix:s,quiet:l,release:c,repository:f});if(w!==j&&(x.push(u),!r))try{await(0,P.writeFile)(u,j,"utf8")}catch(O){if(o)throw process.exitCode=1,O;p.warn(`could not write ${u}`,O)}})),x.length>0&&p.info((r?"would have ":"")+`bumped ${x.join(", ")}`),x}(async function(){var o,a;let e=(a=(o=process.argv)==null?void 0:o.slice(2))!=null?a:[],i=G(e,E),{help:t,version:n}=i,r=A(i,["help","version"]);if(t===!0)return console.info(V(E));if(n===!0)return console.info(z(m));await J(r)})();
